<project name="retrotranslator" default="build" basedir=".">

    <property name="version" value="1.0.9"/>

    <property file="build.properties"/>

    <path id="classpath">
        <fileset dir="lib" includes="**/*.jar"/>
    </path>

    <target name="build" depends="dist-bin, dist-src, maven-dist"/>

    <target name="init">
        <delete dir="build"/>
        <delete dir="dist"/>
    </target>

    <target name="compile" depends="init">
        <mkdir dir="build/classes15"/>
        <mkdir dir="build/classes14"/>
        <mkdir dir="build/classes"/>
        <javac fork="yes" srcdir="src" destdir="build/classes15" debug="true"
               classpathref="classpath" executable="${java15_home}/bin/javac"/>
        <delete>
            <fileset dir="build/classes15/net/sf/retrotranslator/transformer"
                     includes="ClassFileTransformer.class ClassPreProcessor.class"/>
        </delete>
        <java classname="net.sf.retrotranslator.transformer.Retrotranslator"
              classpathref="classpath" classpath="build/classes15" failonerror="true"
              jvm="${java15_home}/bin/java" fork="true">
            <arg value="-srcdir"/>
            <arg value="build/classes15"/>
            <arg value="-destdir"/>
            <arg value="build/classes14"/>
            <arg value="-stripsign"/>
            <arg value="-advanced"/>
        </java>
        <java classname="net.sf.retrotranslator.transformer.Retrotranslator"
              classpathref="classpath" classpath="build/classes14" failonerror="true"
              jvm="${java15_home}/bin/java" fork="true">
            <arg value="-srcdir"/>
            <arg value="build/classes14"/>
            <arg value="-destdir"/>
            <arg value="build/classes"/>
            <arg value="-advanced"/>
            <arg value="-srcmask"/>
            <arg value="*.class"/>
        </java>
        <copy todir="build/classes" overwrite="true">
            <fileset dir="build/classes15" includes="**/SignatureListGenerator.class"/>
        </copy>
        <java classname="net.sf.retrotranslator.transformer.SignatureListGenerator"
              classpathref="classpath" classpath="build/classes" failonerror="true"
              jvm="${java15_home}/bin/java" fork="true">
            <arg value="build/classes/net/sf/retrotranslator/runtime/impl/signatures.properties"/>
        </java>
        <jar destfile="build/retrotranslator-runtime-${version}.jar">
            <fileset dir="build/classes" includes="net/sf/retrotranslator/runtime/**"/>
            <zipfileset file="doc/LICENSE.txt" fullpath="RETROTRANSLATOR-LICENSE.txt"/>
            <fileset file="doc/ASM-LICENSE.txt"/>
            <manifest>
                <attribute name="Implementation-Title" value="Retrotranslator Runtime"/>
                <attribute name="Implementation-Version" value="${version}"/>
            </manifest>
        </jar>
        <jar destfile="build/retrotranslator-transformer-${version}.jar">
            <fileset dir="build/classes" includes="net/sf/retrotranslator/transformer/**"
                     excludes="net/sf/retrotranslator/transformer/SignatureListGenerator.class"/>
            <zipfileset file="doc/LICENSE.txt" fullpath="RETROTRANSLATOR-LICENSE.txt"/>
            <manifest>
                <attribute name="Implementation-Title" value="Retrotranslator Transformer"/>
                <attribute name="Implementation-Version" value="${version}"/>
                <attribute name="Class-Path"
                           value="retrotranslator-runtime-${version}.jar backport-util-concurrent.jar"/>
                <attribute name="Main-Class" value="net.sf.retrotranslator.transformer.Retrotranslator"/>
            </manifest>
        </jar>
        <taskdef name="retrotranslator" classname="net.sf.retrotranslator.transformer.RetrotranslatorTask">
            <classpath>
                <path refid="classpath"/>
                <pathelement location="build/retrotranslator-runtime-${version}.jar"/>
                <pathelement location="build/retrotranslator-transformer-${version}.jar"/>
            </classpath>
        </taskdef>
        <delete dir="build/classes" includes="**/*JITRetrotranslator* **/RetrotranslatorTask*"/>
        <retrotranslator srcdir="build/classes" verify="true" classpath="${java14_rt_jar}" classpathref="classpath"/>
    </target>

    <target name="compile-tests" depends="compile">
        <mkdir dir="build/test-classes15"/>
        <javac srcdir="test" destdir="build/test-classes15"
               fork="yes" debug="true" executable="${java15_home}/bin/javac"
               classpathref="classpath" classpath="build/classes15"/>
        <copy todir="build/test-classes15">
            <fileset dir="test" includes="**/*.properties"/>
        </copy>
    </target>

    <target name="test" depends="test-translated, test-with-jit, test-embedded, test-retainapi, test-custom-backport"/>

    <target name="test-translated" depends="compile-tests">
        <mkdir dir="build/test-classes14"/>
        <copy todir="build/test-classes14">
            <fileset dir="build/test-classes15"/>
        </copy>
        <antcall target="retrotranslate-test-classes14"/>
        <!-- twice translate and test on Java 1.4 -->
        <antcall target="retrotranslate-test-classes14"/>
        <!-- test on Java 5 -->
        <antcall target="junit-on-translated">
            <param name="java_home" value="${java15_home}"/>
        </antcall>
    </target>

    <target name="test-embedded" depends="compile-tests">
        <mkdir dir="build/test-embedded"/>
        <retrotranslator srcdir="build/test-classes15" destdir="build/test-embedded" advanced="true"
                         embed="com.mycompany.internal" srcmask="*.class;*.properties"/>
        <echo message="Running classes in build/test-embedded on ${java14_home}"/>
        <junit printsummary="withOutAndErr" fork="yes" forkmode="once"
               jvm="${java14_home}/bin/java" failureproperty="test.failed">
            <jvmarg value="-Xfuture"/>
            <classpath location="build/test-embedded"/>
            <formatter type="brief" usefile="false"/>
            <batchtest>
                <fileset dir="build/test-embedded" includes="**/*TestCase.class">
                    <exclude name="**/BaseTestCase.class"/>
                </fileset>
            </batchtest>
        </junit>
        <fail if="test.failed"/>
    </target>

    <target name="test-custom-backport" depends="compile-tests">
        <mkdir dir="build/test-custom-backport"/>
        <java classname="net.sf.retrotranslator.transformer.Retrotranslator"
              classpathref="classpath" classpath="build/retrotranslator-transformer-${version}.jar"
              failonerror="true" jvm="${java15_home}/bin/java" fork="true">
            <classpath location="build/test-classes15" />
            <arg value="-srcdir"/>
            <arg value="build/test-classes15"/>
            <arg value="-destdir"/>
            <arg value="build/test-custom-backport"/>
            <arg value="-backport"/>
            <arg value="net.sf.retrotranslator.tests"/>
        </java>
        <echo message="Running classes in build/test-custom-backporton ${java14_home}"/>
        <junit printsummary="withOutAndErr" fork="yes" forkmode="once"
               jvm="${java14_home}/bin/java" failureproperty="test.failed">
            <jvmarg value="-Xfuture"/>
            <sysproperty key="net.sf.retrotranslator.custom-backport" value="true"/>
            <classpath>
                <path refid="classpath"/>
                <pathelement location="build/test-custom-backport"/>
                <pathelement location="build/retrotranslator-runtime-${version}.jar"/>
            </classpath>
            <formatter type="brief" usefile="false"/>
            <test name="net.sf.retrotranslator.tests.CustomBackportTestCase"/>
        </junit>
        <fail if="test.failed"/>
    </target>

    <target name="test-retainapi" depends="compile-tests">
        <mkdir dir="build/test-retainapi"/>
        <retrotranslator srcdir="build/test-classes15" destdir="build/test-retainapi" retainapi="true"/>
        <echo message="Running classes in build/test-retainapi on ${java14_home}"/>
        <junit printsummary="withOutAndErr" fork="yes" forkmode="once"
               jvm="${java14_home}/bin/java" failureproperty="test.failed">
            <jvmarg value="-Xfuture"/>
            <sysproperty key="net.sf.retrotranslator.retain-api" value="true"/>
            <classpath location="build/test-retainapi"/>
            <formatter type="brief" usefile="false"/>
            <test name="net.sf.retrotranslator.tests.RetainAPITestCase"/>
        </junit>
        <fail if="test.failed"/>
    </target>

    <target name="retrotranslate-test-classes14">
        <retrotranslator srcdir="build/test-classes14" advanced="true" verify="true" srcmask="*.class;*.properties">
            <classpath path="${java14_rt_jar}"/>
            <classpath location="build/retrotranslator-runtime-${version}.jar"/>
            <classpath refid="classpath"/>
        </retrotranslator>
        <antcall target="junit-on-translated">
            <param name="java_home" value="${java14_home}"/>
        </antcall>
    </target>

    <target name="test-with-jit" depends="compile-tests">
        <java classname="net.sf.retrotranslator.transformer.JITRetrotranslator" failonerror="true"
              fork="true" jvm="${java14_home}/bin/java"
              classpath="${java.class.path}" classpathref="classpath">
            <classpath path="build/retrotranslator-transformer-${version}.jar"/>
            <arg value="-advanced"/>
            <arg value="org.apache.tools.ant.launch.Launcher"/>
            <arg value="junit-for-jit"/>
        </java>
    </target>

    <target name="junit-for-jit">
        <echo message="Running classes in test-classes15 on ${java.home}"/>
        <junit printsummary="withOutAndErr" fork="no" reloading="false" failureproperty="test.failed">
            <formatter type="brief" usefile="false"/>
            <classpath location="build/test-classes15"/>
            <batchtest>
                <fileset dir="build/test-classes15" includes="**/*TestCase.class">
                    <exclude name="**/BaseTestCase.class"/>
                    <exclude name="**/TextFileTransformerTestCase.class"/>
                </fileset>
            </batchtest>
        </junit>
        <fail if="test.failed"/>
    </target>

    <target name="junit-on-translated">
        <echo message="Running classes in build/test-classes14 on ${java_home}"/>
        <junit printsummary="withOutAndErr" fork="yes" forkmode="once"
               jvm="${java_home}/bin/java" failureproperty="test.failed">
            <jvmarg value="-Xfuture"/>
            <classpath>
                <path refid="classpath"/>
                <pathelement location="build/test-classes14"/>
                <pathelement location="build/retrotranslator-runtime-${version}.jar"/>
            </classpath>
            <formatter type="brief" usefile="false"/>
            <batchtest>
                <fileset dir="build/test-classes14" includes="**/*TestCase.class">
                    <exclude name="**/BaseTestCase.class"/>
                </fileset>
            </batchtest>
        </junit>
        <fail if="test.failed"/>
    </target>

    <target name="dist-bin" depends="test">
        <mkdir dir="dist"/>
        <property name="bin.name" value="Retrotranslator-${version}-bin"/>
        <zip destfile="dist/${bin.name}.zip">
            <zipfileset prefix="${bin.name}" dir="doc"/>
            <zipfileset prefix="${bin.name}" dir="build">
                <include name="retrotranslator-runtime-${version}.jar"/>
                <include name="retrotranslator-transformer-${version}.jar"/>
            </zipfileset>
            <zipfileset prefix="${bin.name}" dir="lib">
                <include name="backport-util-concurrent.jar"/>
            </zipfileset>
        </zip>
    </target>

    <target name="dist-src" depends="test">
        <mkdir dir="dist"/>
        <property name="src.name" value="Retrotranslator-${version}-src"/>
        <zip destfile="dist/${src.name}.zip">
            <zipfileset prefix="${src.name}" dir=".">
                <include name="conf/**"/>
                <include name="doc/**"/>
                <include name="lib/**"/>
                <include name="src/**"/>
                <include name="test/**"/>
                <include name="build.xml"/>
                <include name="build_macosx.properties"/>
                <include name="build_windows.properties"/>
            </zipfileset>
        </zip>
    </target>

    <target name="maven-dist" depends="test" description="Creates the maven deployment units">
        <mkdir dir="dist/maven"/>
        <filter token="version" value="${version}"/>

        <mkdir dir="build/maven/runtime"/>
        <copy todir="build/maven/runtime" file="conf/runtime/pom.xml" filtering="on"/>
        <jar destfile="dist/maven/retrotranslator-runtime-${version}-bundle.jar">
            <fileset file="build/maven/runtime/pom.xml"/>
            <fileset file="build/retrotranslator-runtime-${version}.jar"/>
        </jar>

        <mkdir dir="build/maven/transformer"/>
        <copy todir="build/maven/transformer" file="conf/transformer/pom.xml" filtering="on"/>
        <jar destfile="dist/maven/retrotranslator-transformer-${version}-bundle.jar">
            <fileset file="build/maven/transformer/pom.xml"/>
            <fileset file="build/retrotranslator-transformer-${version}.jar"/>
        </jar>
    </target>

    <target name="maven-install" depends="compile"
            description="Installs the compile units into the current Maven 2 repository">
        <property name="maven.dir" value="${user.home}/.m2/repository/net/sf/retrotranslator"/>
        <property name="runtime.dir" value="${maven.dir}/retrotranslator-runtime/${version}"/>
        <property name="transformer.dir" value="${maven.dir}/retrotranslator-transformer/${version}"/>

        <mkdir dir="${runtime.dir}"/>
        <mkdir dir="${transformer.dir}"/>
        <filter token="version" value="${version}"/>

        <copy todir="${runtime.dir}" file="build/retrotranslator-runtime-${version}.jar"/>
        <copy todir="${transformer.dir}" file="build/retrotranslator-transformer-${version}.jar"/>

        <copy tofile="${runtime.dir}/retrotranslator-runtime-${version}.pom" file="conf/runtime/pom.xml"
              filtering="on"/>
        <copy tofile="${transformer.dir}/retrotranslator-transformer-${version}.pom" file="conf/transformer/pom.xml"
              filtering="on"/>
    </target>
</project>